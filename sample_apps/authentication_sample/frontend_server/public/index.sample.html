<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Spark Sample Application</title>
        <meta charset="utf-8">
        <!-- Bootstrap core CSS -->
        <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">

        <style>
            #login-button, #logout-button{display: none}
        </style>
    </head>

    <body>
        <div class="container">
            <div class="col-md-6 col-md-offset-3">
                <div id="welcome-wrapper">
                    <h2>Spark SDK Authentication Sample</h2>

                    <div class="col-md-10 col-md-offset-1">
                        <p>Guest Token: <span id="guest-token-span">none</span></p>
                        <p>Access Token: <span id="access-token-span">none</span></p>

                        <button id="login-button" class="btn btn-primary">Login</button>
                        <button id="logout-button" class="btn btn-danger">Logout</button>
                        <button id="guest-button" class="btn btn-primary">Get Guest Token</button>
                    </div>
                </div>
            </div>

        </div>
        <br>
        <div class="container">
            <div class="col-md-6 col-md-offset-3">
                <div id="test-wrapper-printer-types">
                    <h2>Spark SDK Test</h2>

                    <div class="col-md-10 col-md-offset-1">
                        <button id="printer-types" class="btn btn-primary">Get Printer Types</button>
                        <br>
                        <p>Printer Types:<br>
                        <pre id="printer-types-list"></pre>
                        </p>
                    </div>
                </div>
            </div>

        </div>
        <br>
        <div class="container">
            <div class="col-md-6 col-md-offset-3">
                <div id="test-wrapper-upload-file">
                    <h2>Spark SDK Upload Test</h2>

                    <div class="col-md-10 col-md-offset-1">
                        <form id="upload-form">
                         <input id="upload-file" class="btn btn-primary" type="file" />
                        </form>
                        <p>Status:<br>
                        <pre id="upload-log"></pre>
                        </p>
                    </div>
                </div>
            </div>

        </div>

        <!-- /container -->

        <script type="text/javascript" charset="utf-8" src="//code.jquery.com/jquery-2.1.3.min.js"></script>

        <!-- spark sdk -->
        <!-- TODO: For now include the source directly. Change this to installed minified source file -->
        <script type="text/javascript" charset="utf-8" src="utilities/Helpers.js"></script>
        <script type="text/javascript" charset="utf-8" src="utilities/Request.js"></script>
        <script type="text/javascript" charset="utf-8" src="Client.js"></script>
        <script type="text/javascript" charset="utf-8" src="PrintDB.js"></script>
        <script type="text/javascript" charset="utf-8" src="MeshAPI.js"></script>
        <script type="text/javascript" charset="utf-8" src="Tasks.js"></script>
        <!-- end spark sdk -->

        <script>
            var APP_KEY = ''; // Your app key
            var API_ROOT = 'sandbox';  // Use 'sandbox' for testing and 'api' for production.

            // The guest token endpoint that is implemented by your server (i.e. http://example.com/guest_token)
            var GUEST_TOKEN_URL = 'http://localhost:3000/guest_token';
            // The access token endpoint that is implemented by your server (i.e. http://example.com/access_token)
            var ACCESS_TOKEN_URL = 'http://localhost:3000/access_token';
            // The refresh token endpoint that is implemented by your server (i.e. http://example.com/refresh_token)
            var REFRESH_TOKEN_URL = 'http://localhost:3000/access_token';

            /**
             * Get the code param in URL after returning from Spark Auth flow
             */
            function extractRedirectionCode() {
                var getParams = ADSKSpark.Helpers.extractParamsFromURL();
                return getParams['code'] ? getParams['code'] : null;
            }

            /**
             * Run when DOM is ready.
             * The spark object already exists in this point
             */
            jQuery(function ($) {
                // Initialize the client
                var Client = ADSKSpark.Client;
                var API_URL = 'https://' + API_ROOT + '.spark.autodesk.com/api/v1';
                Client.initialize(APP_KEY, GUEST_TOKEN_URL, ACCESS_TOKEN_URL, REFRESH_TOKEN_URL, API_URL);

                //First let's see if we have a valid access token
                if (Client.isAccessTokenValid()) {
                    $('#access-token-span').text(Client.getAccessToken());
                    $('#logout-button').show();
                } else {//user needs to login
                    $('#login-button').show();
                    //if we get back from the login service
                    var code = extractRedirectionCode();

                    if (code) {
                        Client.completeLogin(code).then(function (token) {
                            console.log('Completed login with token: ' + token);
                            if (token) {
                                //You can redirect now to some page in your app or to homepage
                                // or to reload the top window or any other action
                                window.location.reload();
                            } else {
                                console.error('Problem with fetching token');
                            }
                        }, function (error) {
                            console.error(JSON.parse(error.message));
                        });
                    }
                }

                // Register buttons
                $('#login-button').click(function() {
                    window.location = Client.getLoginRedirectUrl();
                });

                $('#logout-button').click(function() {
                    Client.logout();
                    window.location.reload();
                });

                $('#guest-button').click(function() {
                    Client.getGuestToken().then(function(token) {
                        $('#guest-token-span').text(token);
                    });
                });

                $('#printer-types').click(function() {
                    ADSKSpark.PrintDB.getPrinterTypes().then(function(types) {
                        for( var i=types.length;  --i >= 0; ) {
                            var p = types[i];
                            var report = p.manufacturer + ': <b>' + p.name + '</b> [' + p.technology + ']<br>';
                            $('#printer-types-list').append(report);
                        }
                    })
                    .catch( function(error) {
                        $('#printer-types-list').text(error.message);
                    });
                });

                $('#upload-file').change(function(event) {
                    var file = this.files[0];
                    var MeshAPI = ADSKSpark.MeshAPI;
                    MeshAPI.uploadFile(file)
                        .then(function(result) {
                            var upload = result.files[0];
                            var report = '<b>Uploaded file:</b> ' + upload.name +
                                         ' ID: ' + upload.file_id +
                                         ' typeof(ID): ' + typeof(upload.file_id) + '\n\n';
                            $('#upload-log').append(report);
                            return MeshAPI.importMesh(upload.file_id, upload.name, true);
                        })
                        .then(function(mesh) {
                            var report = '<b>Imported mesh:</b> ' + mesh.name + ' ID: ' + mesh.id + '\n';
                            report += '<b>Visual file:</b> ' + mesh.visual_file_id + '\n';
                            $('#upload-log').append(report);
                        })
                        .catch(function(err) {
                            var report = '<b>ERROR:</b> ' + err.message + '\n';
                            if( err.responseText )
                                report += '<b>Response:</b> ' + err.responseText + '\n';
                            $('#upload-log').append(report);
                        });
                });
            });
        </script>
    </body>
</html>
